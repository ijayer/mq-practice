---
title: "Rabbitmq | 06 - RPC"
date: 2019-06-22T22:56:56+08:00
lastmod: 2019-06-23 22:56:56
draft: false
keywords: [mq,rabbitmq,go]
description: ""
tags: [mq,rabbitmq,golang]
categories: [tech]
author: "jayer"
---

<!-- æ‘˜è¦ -->

è¿™ä¸€èŠ‚ä½¿ç”¨ RabbitMQ æ„å»º RPC ç³»ç»Ÿï¼šåŒ…å«ä¸€ä¸ªå®¢æˆ·ç«¯å’Œä¸€ä¸ªå¯æ‰©å±•çš„æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„ RPC Serviceï¼Œç”¨æ¥è¿”å› Fibonacci æ•°

<!--more-->

æœ‰å…³ RPC çš„è¯´æ˜ï¼š

å°½ç®¡ RPC åœ¨è®¡ç®—è¿‡ç¨‹ä¸­æ˜¯ä¸€ä¸ªéå¸¸å¸¸è§çš„æ¨¡å‹ï¼Œå®ƒä¹Ÿç»å¸¸å—åˆ°æ‰¹è¯„ã€‚å½“ç¨‹åºå‘˜å¹¶ä¸æ³¨æ„ä¸€ä¸ªå‡½æ•°æ˜¯å¦æ˜¯æœ¬åœ°è°ƒç”¨ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªè€—æ—¶çš„ RPC æ—¶ï¼Œé—®é¢˜å°±æ¥äº†ã€‚åƒè¿™æ ·çš„è¿·æƒ‘å°±ä¼šå¯¼è‡´äº§ç”Ÿä¸å¯é¢„çŸ¥çš„ç³»ç»Ÿå¹¶ä¸”å¢åŠ ä¸å¿…è¦çš„è°ƒè¯•çš„å¤æ‚åº¦ã€‚é”™è¯¯çš„ä½¿ç”¨ RPC ä¹Ÿå°†å¯¼è‡´éš¾ä»¥ç»´æŠ¤çš„æ„å¤§åˆ©é¢å¼çš„ä»£ç äº§ç”Ÿã€‚

> ç‰¢è®°è¿™ä¸€ç‚¹ï¼Œç„¶åè€ƒè™‘ä¸‹é¢çš„è¿™äº›å»ºè®®ï¼š
> 
> - ç¡®ä¿å“ªä¸ªå‡½æ•°æ˜æ˜¾æ˜¯æœ¬åœ°è°ƒç”¨ï¼Œå“ªä¸ªå‡½æ•°æ˜æ˜¾æ˜¯è¿œç¨‹è°ƒç”¨
> - ç³»ç»Ÿè®¾è®¡è¦æ–‡æ¡£åŒ–ï¼Œå¹¶ä¸”è¦ä½¿ç»„ä»¶é—´çš„ä¾èµ–æ¸…æ™°å¯è§
> - é”™è¯¯å¤„ç†åœºæ™¯ï¼šå½“ RPC Server å®•æœºå¾ˆé•¿æ—¶é—´çš„æ—¶å€™å®¢æˆ·ç«¯åº”è¯¥å¦‚ä½•åº”å¯¹?

# Callback queue

ä¸€èˆ¬æ¥è¯´ï¼Œä½¿ç”¨ RabbitMQ å¤„ç† RPC è°ƒç”¨å¾ˆå®¹æ˜“ï¼šå®¢æˆ·ç«¯å‘é€è¯·æ±‚æ¶ˆæ¯ï¼ŒæœåŠ¡ç«¯å›åº”å“åº”æ¶ˆæ¯ã€‚é‚£ä¹ˆï¼Œä¸ºäº†èƒ½å¤Ÿæ”¶åˆ°å“åº”æ¶ˆæ¯ï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨è¯·æ±‚æ¶ˆæ¯ä¸­æºå¸¦ä¸€ä¸ª `å›è°ƒé˜Ÿåˆ—çš„åœ°å€ï¼ˆcallback queue addressï¼‰`ã€‚æˆ‘ä»¬ä½¿ç”¨é»˜è®¤çš„é˜Ÿåˆ—æ¥å°è¯•ä¸€ä¸‹å§ï¼

```go
q, err := ch.QueueDeclare(
    "",     // default queue name
    false,  // durable
    false,  // delete when usused
    true,   // exclusive
    false,  // noWait
    nil,    // arguments
)

err = ch.Publish(
    "",             // exchange
    "rpc_queue",    // routing key
    false,          // mandatory
    false,          // immediate
    amqp.Publishing {
        ContentType: "text/plain",
        CorrelationId: corrId,
        ReplyTo: q.Name,
        Body: []byte(strconv.Itoa(n)),
    }
)
```

> æ¶ˆæ¯å±æ€§è¯´æ˜ï¼›AMQP 0-9-1 åè®®é¢„å®šä¹‰äº† 14 ä¸ªæ¶ˆæ¯çš„å±æ€§ï¼Œä½†æ˜¯å¤§å¤šæ•°éƒ½ä¸æ€ä¹ˆä½¿ç”¨ï¼Œéƒ¨åˆ†è¯´æ˜å¦‚ä¸‹:
> 
> - `persistent`: æ ‡è®°æ¶ˆæ¯æ˜¯å¦è¦è¢«æŒä¹…åŒ–(true | false)
> - `content_type`ï¼šæ¶ˆæ¯ç¼–ç ç±»å‹(application/json | text/plain)
> - `reply_to`: å›è°ƒé˜Ÿåˆ—å
> - `correlation_id`ï¼šç”¨æ¥å°† RPC å“åº”å’Œè¯·æ±‚å…³è”

# Correlation Id

ä¸Šé¢æåˆ°çš„ä¸ºæ¯ä¸ª RPC è¯·æ±‚åˆ›å»ºä¸€ä¸ªå›è°ƒé˜Ÿåˆ—æ•ˆç‡å¹¶ä¸é«˜ï¼Œä½†å¹¸è¿çš„æ˜¯è¿™æœ‰ä¸€ä¸ªæ›´å¥½çš„æ–¹å¼ï¼šä¸ºæ¯ä¸ªå®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ª `å›è°ƒé˜Ÿåˆ—(callback queue)`ã€‚

è¿™å°±å¼•å‡ºäº†ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼Œåœ¨å›è°ƒé˜Ÿåˆ—ä¸­æ”¶åˆ°çš„å“åº”å¹¶ä¸èƒ½æ¸…æ™°çš„æ ‡æ˜æ˜¯æ¥è‡ªé‚£ä¸ªè¯·æ±‚çš„å“åº”ã€‚è¿™å°±è¦ä½¿ç”¨ä¸€ä¸ªå±æ€§ `correlation_id`ï¼ˆå…³è”idï¼‰ã€‚æˆ‘ä»¬å¯ä»¥ç»™æ¯ä¸ªè¯·æ±‚éƒ½è®¾ç½®ä¸€ä¸ªå”¯ä¸€çš„å€¼ï¼Œéšåï¼Œæˆ‘ä»¬åœ¨å›è°ƒé˜Ÿåˆ—æ”¶åˆ°å“åº”çš„æ—¶å€™å°±æ¯”å¯¹è¿™ä¸ªå±æ€§ï¼ŒåŸºäºæ­¤ï¼Œæˆ‘ä»¬å°±èƒ½å°†å“åº”å’Œè¯·æ±‚å¯¹åº”èµ·æ¥ã€‚å¦‚æœæˆ‘ä»¬æ”¶åˆ°äº†ä¸€ä¸ªæœªçŸ¥çš„ `correlation_id`ï¼Œè¯´æ˜è¯¥æ¶ˆæ¯ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œå¯ä»¥å®Œå…¨ä¸¢å¼ƒã€‚

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼šæ—¢ç„¶æ”¶åˆ°äº†ä¸æ˜¯æ¥è‡ªæˆ‘ä»¬è¯·æ±‚çš„å“åº”ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥æŠ¥é”™ï¼Œè€Œæ˜¯é€‰æ‹©ä¸¢å¼ƒå‘¢ï¼Ÿé‚£æ˜¯å› ä¸ºåœ¨ Server ç«¯å­˜åœ¨ç«äº‰æ£€æµ‹çš„å¯èƒ½ã€‚å°½ç®¡ä¸å¤ªå¯èƒ½ï¼Œä½† RPC server ä¹Ÿæœ‰å¯èƒ½åœ¨å‘é€å“åº”åå°±å®•æœºäº†ï¼Œè€Œä¸”åœ¨å®•æœºå‰ä¹Ÿæ²¡æ¥å¾—åŠå‘é€ ackã€‚å¦‚æœè¿™ç§æƒ…å†µå‘ç”Ÿäº†ï¼Œé‡å¯ RPC æœåŠ¡åä¼šå†æ¬¡å¤„ç†è¿™ä¸ªè¯·æ±‚ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨å®¢æˆ·ç«¯ä¸Šæˆ‘ä»¬å¿…é¡»ä¼˜é›…çš„å¤„ç†é‡å¤çš„å“åº”ï¼Œç†æƒ³æƒ…å†µä¸‹ RPC åº”è¯¥æ˜¯å¹‚ç­‰çš„ã€‚

# Summary

![](https://www.rabbitmq.com/img/tutorials/python-six.png)

ä¸Šå›¾ä¸­çš„ RPC å·¥ä½œæµï¼š

- å½“å®¢æˆ·ç«¯å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šåˆ›å»ºä¸€ä¸ªåŒ¿åç‹¬å çš„å›è°ƒé˜Ÿåˆ—
- ä¸€ä¸ª RPC è¯·æ±‚ä¸­ï¼Œå®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯ä¼šå¸¦ä¸¤ä¸ªå±æ€§ï¼š`reply_to`ï¼šå…¶å€¼ä¸ºå›è°ƒé˜Ÿåˆ—ï¼Œ`correlation_id`ï¼šä¸ºæ¯ä¸ªè¯·æ±‚è®¾ç½®çš„å”¯ä¸€å€¼
- Request å°†è¢«å‘é€åˆ°ä¸€ä¸ª RPC é˜Ÿåˆ—
- RPC Server ç­‰å¾…æ¥è‡ª rpc_queue é˜Ÿåˆ—çš„è¯·æ±‚ã€‚å½“è¯·æ±‚åˆ°è¾¾åï¼Œä»–å°±ä¼šå¤„ç†å…¶ä»»åŠ¡ï¼Œå¹¶å°†å¤„ç†ç»“æœé€šè¿‡ `reply_to` å­—æ®µæ‰€è¡¨ç¤ºçš„å›è°ƒé˜Ÿåˆ—é€å›ç»™å®¢æˆ·ç«¯ã€‚ 
- å®¢æˆ·ç«¯ç­‰å¾…å›è°ƒé˜Ÿåˆ—çš„æ•°æ®ã€‚å½“æ¶ˆæ¯åˆ°è¾¾åï¼Œå…ˆæ£€æŸ¥ `correlatioin_id`ï¼Œå¦‚æœå’Œè¯·æ±‚ä¸­çš„å€¼åŒ¹é…ï¼Œåˆ™å°† Response è¿”å›ç»™åº”ç”¨ç¨‹åºã€‚

å®Œæ•´ [Demo Code][#3] 

# See Also

> Thanks to the authors ğŸ™‚

* [RPC][#1]
  
[#1]:https://www.rabbitmq.com/tutorials/tutorial-six-go.html
[#3]:https://github.com/ijayer/mq-practice/tree/master/rabbitmq/golang-intro/06-rpc

# Content

- [01-hello world](../01-hello-world)
- [02-work-queues](../02-work-queues)
- [03-publish/subscribe](../03-publish-subscribe)
- [04-routing](../04-routing)
- [05-topics](../05-topics)
- [06-rpc](../06-rpc)
